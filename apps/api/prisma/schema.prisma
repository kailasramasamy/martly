generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ── Enums ─────────────────────────────────────────────

enum UserRole {
  SUPER_ADMIN
  ORG_ADMIN
  STORE_MANAGER
  STAFF
  CUSTOMER
}

enum StoreStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CLOSED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum UnitType {
  KG
  GRAM
  LITER
  ML
  PIECE
  PACK
  DOZEN
  BUNDLE
}

enum FoodType {
  VEG
  NON_VEG
  VEGAN
  EGG
}

enum ProductType {
  GROCERY
  SNACKS
  BEVERAGES
  DAIRY
  FROZEN
  FRESH_PRODUCE
  BAKERY
  PERSONAL_CARE
  HOUSEHOLD
  BABY_CARE
  PET_CARE
  OTC_PHARMA
}

enum StorageType {
  AMBIENT
  REFRIGERATED
  DEEP_CHILLED
  FROZEN
  COOL_DRY
  HUMIDITY_CONTROLLED
}

enum DiscountType {
  FLAT
  PERCENTAGE
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PaymentMethod {
  ONLINE
  COD
}

enum FulfillmentType {
  DELIVERY
  PICKUP
}

enum WalletTransactionType {
  CREDIT
  DEBIT
}

enum LoyaltyTransactionType {
  EARN
  REDEEM
  REVERSAL
  ADJUSTMENT
}

enum TripStatus {
  CREATED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum BannerPlacement {
  HERO_CAROUSEL
  CATEGORY_STRIP
  MID_PAGE
  CATEGORY_TOP
  CART_UPSELL
  POPUP
}

enum BannerActionType {
  CATEGORY
  PRODUCT
  COLLECTION
  SEARCH
  URL
  NONE
}

enum NotificationType {
  ORDER_CONFIRMED
  ORDER_PREPARING
  ORDER_READY
  ORDER_OUT_FOR_DELIVERY
  ORDER_DELIVERED
  ORDER_CANCELLED
  WALLET_CREDITED
  WALLET_DEBITED
  LOYALTY_POINTS_EARNED
  LOYALTY_POINTS_REDEEMED
  PROMOTIONAL
  GENERAL
  WELCOME
  REVIEW_REQUEST
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

enum AudienceType {
  ALL_CUSTOMERS
  STORE_CUSTOMERS
  ORDERED_LAST_N_DAYS
  NOT_ORDERED_N_DAYS
  HIGH_VALUE_CUSTOMERS
}

enum ReferralStatus {
  PENDING
  COMPLETED
  EXPIRED
}

enum TicketStatus {
  OPEN
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}

// ── Models ────────────────────────────────────────────

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  stores              Store[]
  products            Product[]
  collections         Collection[]
  coupons             Coupon[]
  deliveryZones       DeliveryZone[]
  loyaltyConfig       LoyaltyConfig?
  loyaltyBalances     LoyaltyBalance[]
  loyaltyTransactions LoyaltyTransaction[]
  deliveryTrips       DeliveryTrip[]
  banners             Banner[]
  notificationCampaigns NotificationCampaign[]
  notificationTemplates NotificationTemplate[]
  referralConfig      ReferralConfig?
  referrals           Referral[]
  supportTickets      SupportTicket[]

  @@map("organizations")
}

model Store {
  id             String      @id @default(uuid())
  organizationId String      @map("organization_id")
  name           String
  slug           String      @unique
  address        String
  phone          String?
  status         StoreStatus @default(PENDING)
  latitude       Float?      @map("latitude")
  longitude      Float?      @map("longitude")
  deliveryRadius Float       @default(7) @map("delivery_radius")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  organization       Organization        @relation(fields: [organizationId], references: [id])
  storeProducts      StoreProduct[]
  userStores         UserStore[]
  orders             Order[]
  reviews            Review[]
  storeDeliveryZones    StoreDeliveryZone[]
  deliveryTiers         DeliveryTier[]
  deliverySlots         DeliverySlot[]
  expressDeliveryConfig ExpressDeliveryConfig?
  deliveryTrips         DeliveryTrip[]
  banners               Banner[]
  storeRatings          StoreRating[] @relation("StoreRatings")
  supportTickets        SupportTicket[]

  @@map("stores")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String
  passwordHash String   @map("password_hash")
  phone        String?
  role         UserRole @default(CUSTOMER)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  walletBalance Decimal @default(0) @db.Decimal(10, 2) @map("wallet_balance")
  referralCode  String? @unique @map("referral_code")

  userStores           UserStore[]
  orders               Order[]
  deviceTokens         DeviceToken[]
  addresses            UserAddress[]
  reviews              Review[]
  wishlistItems        WishlistItem[]
  couponRedemptions    CouponRedemption[]
  walletTransactions   WalletTransaction[]
  loyaltyBalances      LoyaltyBalance[]
  loyaltyTransactions  LoyaltyTransaction[]
  deliveryTrips        DeliveryTrip[]
  notifications        Notification[]
  campaignsSent        NotificationCampaign[] @relation("CampaignsSent")
  templatesCreated     NotificationTemplate[] @relation("TemplatesCreated")
  reviewReplies        ReviewReply[]          @relation("ReviewReplies")
  storeRatings         StoreRating[]          @relation("StoreRatings")
  referralsMade        Referral[]             @relation("ReferralsMade")
  referralReceived     Referral[]             @relation("ReferralReceived")
  supportTickets       SupportTicket[]

  @@map("users")
}

model UserAddress {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  label     String   @default("Home")
  placeName String?  @map("place_name")
  address   String
  latitude  Float?   @map("latitude")
  longitude Float?   @map("longitude")
  pincode   String?  @map("pincode")
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_addresses")
}

model UserStore {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  storeId   String   @map("store_id")
  role      UserRole @default(STAFF)
  createdAt DateTime @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id])
  store Store @relation(fields: [storeId], references: [id])

  @@unique([userId, storeId])
  @@map("user_stores")
}

model Category {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  parentId  String?  @map("parent_id")
  sortOrder Int      @default(0) @map("sort_order")
  imageUrl  String?  @map("image_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children Category[] @relation("CategoryTree")
  products Product[]
  banners  Banner[]

  @@map("categories")
}

model Brand {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  imageUrl  String?  @map("image_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  products Product[]

  @@map("brands")
}

model Product {
  id                  String    @id @default(uuid())
  name                String
  description         String?
  imageUrl            String?   @map("image_url")
  categoryId          String?   @map("category_id")
  brandId             String?   @map("brand_id")
  isActive            Boolean   @default(true) @map("is_active")
  tags                String[]  @default([])
  hsnCode             String?   @map("hsn_code")
  gstPercent          Decimal?  @db.Decimal(4, 2) @map("gst_percent")
  foodType            FoodType? @map("food_type")
  fssaiLicense        String?   @map("fssai_license")
  ingredients         String?
  nutritionalInfo     Json?     @map("nutritional_info")
  allergens           String[]  @default([])
  servingSize         String?   @map("serving_size")
  shelfLifeDays       Int?      @map("shelf_life_days")
  storageType         StorageType? @map("storage_type")
  storageInstructions String?   @map("storage_instructions")
  manufacturerName    String?   @map("manufacturer_name")
  countryOfOrigin     String?      @map("country_of_origin")
  images              String[]     @default([])
  productType         ProductType? @map("product_type")
  regulatoryMarks     String[]     @default([]) @map("regulatory_marks")
  certifications      String[]     @default([])
  mfgLicenseNo        String?      @map("mfg_license_no")
  dangerWarnings      String?      @map("danger_warnings")
  usageInstructions   String?      @map("usage_instructions")
  organizationId      String?          @map("organization_id")
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")

  organization  Organization?    @relation(fields: [organizationId], references: [id])
  category      Category?        @relation(fields: [categoryId], references: [id])
  brand         Brand?           @relation(fields: [brandId], references: [id])
  variants        ProductVariant[]
  storeProducts   StoreProduct[]
  orderItems      OrderItem[]
  collectionItems CollectionItem[]
  reviews         Review[]
  wishlistItems   WishlistItem[]

  @@index([productType])
  @@index([organizationId])
  @@map("products")
}

model ProductVariant {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  name      String
  sku       String?  @unique
  barcode   String?  @unique
  unitType  UnitType @default(PIECE) @map("unit_type")
  unitValue Decimal  @default(1) @db.Decimal(10, 2) @map("unit_value")
  mrp       Decimal? @db.Decimal(10, 2)
  packType  String?  @map("pack_type")
  imageUrl  String?  @map("image_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  discountType  DiscountType?  @map("discount_type")
  discountValue Decimal?       @db.Decimal(10, 2) @map("discount_value")
  discountStart DateTime?      @map("discount_start")
  discountEnd   DateTime?      @map("discount_end")

  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  storeProducts StoreProduct[]
  orderItems    OrderItem[]

  @@map("product_variants")
}

model StoreProduct {
  id        String   @id @default(uuid())
  storeId   String   @map("store_id")
  productId String   @map("product_id")
  variantId String   @map("variant_id")
  price         Decimal @db.Decimal(10, 2)
  stock         Int     @default(0)
  reservedStock Int     @default(0) @map("reserved_stock")
  isActive      Boolean @default(true) @map("is_active")
  isFeatured    Boolean @default(false) @map("is_featured")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  discountType  DiscountType?  @map("discount_type")
  discountValue Decimal?       @db.Decimal(10, 2) @map("discount_value")
  discountStart DateTime?      @map("discount_start")
  discountEnd   DateTime?      @map("discount_end")

  store      Store          @relation(fields: [storeId], references: [id])
  product    Product        @relation(fields: [productId], references: [id])
  variant    ProductVariant @relation(fields: [variantId], references: [id])
  orderItems OrderItem[]

  @@unique([storeId, variantId])
  @@map("store_products")
}

model Order {
  id                   String        @id @default(uuid())
  userId               String        @map("user_id")
  storeId              String        @map("store_id")
  status               OrderStatus   @default(PENDING)
  paymentStatus        PaymentStatus @default(PENDING) @map("payment_status")
  paymentMethod        PaymentMethod  @default(ONLINE) @map("payment_method")
  fulfillmentType      FulfillmentType @default(DELIVERY) @map("fulfillment_type")
  totalAmount          Decimal       @db.Decimal(10, 2) @map("total_amount")
  deliveryAddress      String?       @map("delivery_address")
  razorpayOrderId      String?       @map("razorpay_order_id")
  razorpayPaymentId    String?       @map("razorpay_payment_id")
  couponId             String?       @map("coupon_id")
  couponCode           String?       @map("coupon_code")
  couponDiscount       Decimal?      @db.Decimal(10, 2) @map("coupon_discount")
  deliveryFee          Decimal       @default(0) @db.Decimal(10, 2) @map("delivery_fee")
  deliveryDistance     Float?        @map("delivery_distance")
  deliveryPincode      String?       @map("delivery_pincode")
  estimatedDeliveryAt  DateTime?     @map("estimated_delivery_at")
  deliveryNotes        String?       @map("delivery_notes")
  walletAmountUsed     Decimal?      @db.Decimal(10, 2) @map("wallet_amount_used")
  loyaltyPointsUsed    Int?          @map("loyalty_points_used")
  loyaltyPointsEarned  Int?          @map("loyalty_points_earned")
  deliverySlotId       String?       @map("delivery_slot_id")
  deliveryTripId       String?       @map("delivery_trip_id")
  scheduledDate        DateTime?     @map("scheduled_date")
  slotStartTime        String?       @map("slot_start_time")
  slotEndTime          String?       @map("slot_end_time")
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")

  user                User                @relation(fields: [userId], references: [id])
  store               Store               @relation(fields: [storeId], references: [id])
  coupon              Coupon?             @relation(fields: [couponId], references: [id])
  deliverySlot        DeliverySlot?       @relation(fields: [deliverySlotId], references: [id])
  deliveryTrip        DeliveryTrip?       @relation(fields: [deliveryTripId], references: [id])
  items               OrderItem[]
  couponRedemptions   CouponRedemption[]
  statusLogs          OrderStatusLog[]
  walletTransactions  WalletTransaction[]
  loyaltyTransactions LoyaltyTransaction[]
  storeRatings        StoreRating[]
  reviews             Review[]
  supportTickets      SupportTicket[]

  @@map("orders")
}

model DeviceToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  platform  String   @default("unknown")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("device_tokens")
}

model OrderItem {
  id             String  @id @default(uuid())
  orderId        String  @map("order_id")
  productId      String  @map("product_id")
  variantId      String  @map("variant_id")
  storeProductId String  @map("store_product_id")
  quantity       Int
  unitPrice      Decimal @db.Decimal(10, 2) @map("unit_price")
  totalPrice     Decimal @db.Decimal(10, 2) @map("total_price")

  originalPrice Decimal?      @db.Decimal(10, 2) @map("original_price")
  discountType  DiscountType? @map("discount_type")
  discountValue Decimal?      @db.Decimal(10, 2) @map("discount_value")

  order        Order          @relation(fields: [orderId], references: [id])
  product      Product        @relation(fields: [productId], references: [id])
  variant      ProductVariant @relation(fields: [variantId], references: [id])
  storeProduct StoreProduct   @relation(fields: [storeProductId], references: [id])

  @@map("order_items")
}

model Collection {
  id             String   @id @default(uuid())
  organizationId String?  @map("organization_id")
  title          String
  subtitle       String?
  slug           String   @unique
  imageUrl       String?  @map("image_url")
  sortOrder      Int      @default(0) @map("sort_order")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization? @relation(fields: [organizationId], references: [id])
  items        CollectionItem[]

  @@index([organizationId])
  @@index([isActive, sortOrder])
  @@map("collections")
}

model CollectionItem {
  id           String   @id @default(uuid())
  collectionId String   @map("collection_id")
  productId    String   @map("product_id")
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([collectionId, productId])
  @@map("collection_items")
}

model Coupon {
  id             String       @id @default(uuid())
  code           String       @unique
  description    String?
  discountType   DiscountType @map("discount_type")
  discountValue  Decimal      @db.Decimal(10, 2) @map("discount_value")
  minOrderAmount Decimal?     @db.Decimal(10, 2) @map("min_order_amount")
  maxDiscount    Decimal?     @db.Decimal(10, 2) @map("max_discount")
  usageLimit     Int?         @map("usage_limit")
  perUserLimit   Int          @default(1) @map("per_user_limit")
  usedCount      Int          @default(0) @map("used_count")
  startsAt       DateTime?    @map("starts_at")
  expiresAt      DateTime?    @map("expires_at")
  isActive       Boolean      @default(true) @map("is_active")
  organizationId String?      @map("organization_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization Organization?    @relation(fields: [organizationId], references: [id])
  redemptions  CouponRedemption[]
  orders       Order[]

  @@index([code])
  @@index([organizationId])
  @@index([isActive, expiresAt])
  @@map("coupons")
}

model CouponRedemption {
  id        String   @id @default(uuid())
  couponId  String   @map("coupon_id")
  userId    String   @map("user_id")
  orderId   String   @map("order_id")
  createdAt DateTime @default(now()) @map("created_at")

  coupon Coupon @relation(fields: [couponId], references: [id])
  user   User   @relation(fields: [userId], references: [id])
  order  Order  @relation(fields: [orderId], references: [id])

  @@index([couponId, userId])
  @@map("coupon_redemptions")
}

model Review {
  id         String       @id @default(uuid())
  userId     String       @map("user_id")
  productId  String       @map("product_id")
  storeId    String?      @map("store_id")
  orderId    String?      @map("order_id")
  rating     Int
  title      String?
  comment    String?
  isVerified Boolean      @default(false) @map("is_verified")
  status     ReviewStatus @default(PENDING)
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  user    User         @relation(fields: [userId], references: [id])
  product Product      @relation(fields: [productId], references: [id])
  store   Store?       @relation(fields: [storeId], references: [id])
  order   Order?       @relation(fields: [orderId], references: [id])
  images  ReviewImage[]
  reply   ReviewReply?

  @@unique([userId, productId])
  @@index([productId, status])
  @@map("reviews")
}

model ReviewImage {
  id        String   @id @default(uuid())
  reviewId  String   @map("review_id")
  imageUrl  String   @map("image_url")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@map("review_images")
}

model ReviewReply {
  id        String   @id @default(uuid())
  reviewId  String   @unique @map("review_id")
  userId    String   @map("user_id")
  body      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation("ReviewReplies", fields: [userId], references: [id])

  @@map("review_replies")
}

model StoreRating {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  orderId         String   @map("order_id")
  storeId         String   @map("store_id")
  overallRating   Int      @map("overall_rating")
  deliveryRating  Int?     @map("delivery_rating")
  packagingRating Int?     @map("packaging_rating")
  comment         String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user  User  @relation("StoreRatings", fields: [userId], references: [id])
  order Order @relation(fields: [orderId], references: [id])
  store Store @relation("StoreRatings", fields: [storeId], references: [id])

  @@unique([userId, orderId])
  @@index([storeId])
  @@map("store_ratings")
}

model WishlistItem {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  productId String   @map("product_id")
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@map("wishlist_items")
}

model DeliveryZone {
  id               String   @id @default(uuid())
  name             String
  pincodes         String[] @default([])
  deliveryFee      Decimal  @db.Decimal(10, 2) @map("delivery_fee")
  estimatedMinutes Int      @default(60) @map("estimated_minutes")
  isActive         Boolean  @default(true) @map("is_active")
  organizationId   String   @map("organization_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  organization Organization        @relation(fields: [organizationId], references: [id])
  stores       StoreDeliveryZone[]

  @@index([organizationId])
  @@map("delivery_zones")
}

model StoreDeliveryZone {
  id             String   @id @default(uuid())
  storeId        String   @map("store_id")
  deliveryZoneId String   @map("delivery_zone_id")
  createdAt      DateTime @default(now()) @map("created_at")

  store        Store        @relation(fields: [storeId], references: [id])
  deliveryZone DeliveryZone @relation(fields: [deliveryZoneId], references: [id])

  @@unique([storeId, deliveryZoneId])
  @@map("store_delivery_zones")
}

model DeliveryTier {
  id               String   @id @default(uuid())
  storeId          String   @map("store_id")
  minDistance       Float    @map("min_distance")
  maxDistance       Float    @map("max_distance")
  deliveryFee      Decimal  @db.Decimal(10, 2) @map("delivery_fee")
  estimatedMinutes Int      @default(45) @map("estimated_minutes")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@map("delivery_tiers")
}

model DeliverySlot {
  id            String   @id @default(uuid())
  storeId       String   @map("store_id")
  dayOfWeek     Int      @map("day_of_week")
  startTime     String   @map("start_time")
  endTime       String   @map("end_time")
  maxOrders     Int      @default(20) @map("max_orders")
  cutoffMinutes Int      @default(60) @map("cutoff_minutes")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  store  Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  orders Order[]

  @@unique([storeId, dayOfWeek, startTime, endTime])
  @@index([storeId])
  @@map("delivery_slots")
}

model OrderStatusLog {
  id        String      @id @default(uuid())
  orderId   String      @map("order_id")
  status    OrderStatus
  note      String?
  createdAt DateTime    @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@map("order_status_logs")
}

model WalletTransaction {
  id           String                @id @default(uuid())
  userId       String                @map("user_id")
  orderId      String?               @map("order_id")
  type         WalletTransactionType
  amount       Decimal               @db.Decimal(10, 2)
  balanceAfter Decimal               @db.Decimal(10, 2) @map("balance_after")
  description  String?
  createdAt    DateTime              @default(now()) @map("created_at")

  user  User   @relation(fields: [userId], references: [id])
  order Order? @relation(fields: [orderId], references: [id])

  @@index([userId, createdAt])
  @@index([orderId])
  @@map("wallet_transactions")
}

model LoyaltyConfig {
  id                   String   @id @default(uuid())
  organizationId       String   @unique @map("organization_id")
  isEnabled            Boolean  @default(true) @map("is_enabled")
  earnRate             Int      @default(1) @map("earn_rate")
  minRedeemPoints      Int      @default(10) @map("min_redeem_points")
  maxRedeemPercentage  Int      @default(50) @map("max_redeem_percentage")
  reviewRewardPoints   Int      @default(0) @map("review_reward_points")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id])

  @@map("loyalty_configs")
}

model LoyaltyBalance {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")
  points         Int      @default(0)
  totalEarned    Int      @default(0) @map("total_earned")
  totalRedeemed  Int      @default(0) @map("total_redeemed")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@map("loyalty_balances")
}

model ExpressDeliveryConfig {
  id             String   @id @default(uuid())
  storeId        String   @unique @map("store_id")
  isEnabled      Boolean  @default(true) @map("is_enabled")
  etaMinutes     Int?     @map("eta_minutes")
  operatingStart String?  @map("operating_start")
  operatingEnd   String?  @map("operating_end")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("express_delivery_configs")
}

model LoyaltyTransaction {
  id             String                @id @default(uuid())
  userId         String                @map("user_id")
  organizationId String                @map("organization_id")
  orderId        String?               @map("order_id")
  type           LoyaltyTransactionType
  points         Int
  balanceAfter   Int                   @map("balance_after")
  description    String?
  createdAt      DateTime              @default(now()) @map("created_at")

  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  order        Order?       @relation(fields: [orderId], references: [id])

  @@index([userId, organizationId, createdAt])
  @@index([orderId])
  @@map("loyalty_transactions")
}

model DeliveryTrip {
  id             String     @id @default(uuid())
  storeId        String     @map("store_id")
  riderId        String     @map("rider_id")
  organizationId String     @map("organization_id")
  status         TripStatus @default(CREATED)
  startedAt      DateTime?  @map("started_at")
  completedAt    DateTime?  @map("completed_at")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  store        Store        @relation(fields: [storeId], references: [id])
  rider        User         @relation(fields: [riderId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  orders       Order[]

  @@index([storeId, status])
  @@index([riderId])
  @@map("delivery_trips")
}

model Banner {
  id             String           @id @default(uuid())
  title          String
  subtitle       String?
  imageUrl       String           @map("image_url")
  placement      BannerPlacement
  actionType     BannerActionType @default(NONE) @map("action_type")
  actionTarget   String?          @map("action_target")
  sortOrder      Int              @default(0) @map("sort_order")
  isActive       Boolean          @default(true) @map("is_active")
  startsAt       DateTime?        @map("starts_at")
  endsAt         DateTime?        @map("ends_at")
  storeId        String?          @map("store_id")
  organizationId String?          @map("organization_id")
  categoryId     String?          @map("category_id")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  store        Store?        @relation(fields: [storeId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id])
  category     Category?     @relation(fields: [categoryId], references: [id])

  @@index([placement, isActive])
  @@index([organizationId])
  @@index([storeId])
  @@index([categoryId])
  @@map("banners")
}

model NotificationCampaign {
  id              String           @id @default(uuid())
  organizationId  String           @map("organization_id")
  title           String
  body            String
  type            NotificationType
  imageUrl        String?          @map("image_url")
  data            Json?
  audienceType    AudienceType     @default(ALL_CUSTOMERS) @map("audience_type")
  audienceConfig  Json?            @map("audience_config")
  status          CampaignStatus   @default(SENT)
  recipientCount  Int              @default(0) @map("recipient_count")
  scheduledAt     DateTime?        @map("scheduled_at")
  sentAt          DateTime?        @map("sent_at")
  sentBy          String           @map("sent_by")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  organization  Organization   @relation(fields: [organizationId], references: [id])
  sentByUser    User           @relation("CampaignsSent", fields: [sentBy], references: [id])
  notifications Notification[]

  @@index([organizationId, createdAt])
  @@index([status, scheduledAt])
  @@map("notification_campaigns")
}

model NotificationTemplate {
  id              String           @id @default(uuid())
  organizationId  String           @map("organization_id")
  name            String
  title           String
  body            String
  type            NotificationType @default(PROMOTIONAL)
  imageUrl        String?          @map("image_url")
  createdBy       String           @map("created_by")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id])
  creator      User         @relation("TemplatesCreated", fields: [createdBy], references: [id])

  @@index([organizationId])
  @@map("notification_templates")
}

model Notification {
  id         String           @id @default(uuid())
  userId     String           @map("user_id")
  type       NotificationType
  title      String
  body       String
  imageUrl   String?          @map("image_url")
  data       Json?
  isRead     Boolean          @default(false) @map("is_read")
  campaignId String?          @map("campaign_id")
  createdAt  DateTime         @default(now()) @map("created_at")

  user     User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign NotificationCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([userId, isRead, createdAt])
  @@index([userId, createdAt])
  @@index([campaignId])
  @@map("notifications")
}

model ReferralConfig {
  id                  String   @id @default(uuid())
  organizationId      String   @unique @map("organization_id")
  isEnabled           Boolean  @default(true) @map("is_enabled")
  referrerReward      Decimal  @default(50) @db.Decimal(10, 2) @map("referrer_reward")
  refereeReward       Decimal  @default(25) @db.Decimal(10, 2) @map("referee_reward")
  maxReferralsPerUser Int      @default(50) @map("max_referrals_per_user")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id])

  @@map("referral_configs")
}

model Referral {
  id             String         @id @default(uuid())
  referrerId     String         @map("referrer_id")
  refereeId      String         @map("referee_id")
  organizationId String         @map("organization_id")
  status         ReferralStatus @default(PENDING)
  referrerReward Decimal        @db.Decimal(10, 2) @map("referrer_reward")
  refereeReward  Decimal        @db.Decimal(10, 2) @map("referee_reward")
  orderId        String?        @map("order_id")
  completedAt    DateTime?      @map("completed_at")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  referrer     User         @relation("ReferralsMade", fields: [referrerId], references: [id])
  referee      User         @relation("ReferralReceived", fields: [refereeId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([refereeId, organizationId])
  @@index([referrerId])
  @@index([organizationId])
  @@map("referrals")
}

model SupportTicket {
  id             String         @id @default(uuid())
  userId         String         @map("user_id")
  storeId        String?        @map("store_id")
  orderId        String?        @map("order_id")
  subject        String
  status         TicketStatus   @default(OPEN)
  priority       TicketPriority @default(MEDIUM)
  messages       Json           @default("[]")
  organizationId String?        @map("organization_id")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id])
  store        Store?        @relation(fields: [storeId], references: [id])
  order        Order?        @relation(fields: [orderId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id])

  @@index([userId, createdAt])
  @@index([storeId, status])
  @@index([organizationId, status])
  @@map("support_tickets")
}
